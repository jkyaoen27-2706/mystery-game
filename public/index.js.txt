// functions/index.js
const { GoogleGenAI } = require('@google/genai');

// The Netlify handler function
exports.handler = async (event, context) => {
    // 1. Securely access the API key from Netlify's environment variables
    const GEMINI_API_KEY = process.env.GEMINI_API_KEY; 

    if (!GEMINI_API_KEY) {
        return { statusCode: 500, body: JSON.stringify({ error: "Server configuration missing API Key." }) };
    }
    
    if (event.httpMethod !== 'POST') {
        return { statusCode: 405, body: 'Method Not Allowed' };
    }

    let prompt;
    try {
        // 2. Netlify requires parsing the body string
        const body = JSON.parse(event.body); 
        prompt = body.prompt;

        if (!prompt) {
            return { statusCode: 400, body: JSON.stringify({ error: "Missing 'prompt' in request body." }) };
        }
    } catch (e) {
        return { statusCode: 400, body: JSON.stringify({ error: "Invalid JSON format." }) };
    }
    
    const ai = new GoogleGenAI(GEMINI_API_KEY);

    try {
        const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt
        });

        // 3. Must return a Netlify-compatible response object
        return {
            statusCode: 200,
            body: JSON.stringify({ text: response.text })
        };

    } catch (error) {
        console.error("Gemini Proxy Error:", error);
        return {
            statusCode: 500,
            body: JSON.stringify({ error: "An error occurred during AI processing." })
        };
    }
};